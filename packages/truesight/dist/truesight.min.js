/*!
 * truesight.min.js v0.1.0-alpha.1
 * Copyright (c) 2018-present, Chennara Nhes.
 * Released under the MIT License.
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.truesight=r()}(this,function(){"use strict";class e{constructor(e){this.channels=e}get red(){return this.channels[r]}get green(){return this.channels[t]}get blue(){return this.channels[n]}}const r=0,t=1,n=2;async function o(e){try{return await e()}catch(e){return Promise.reject(e)}}var u=async function(e,r=2e3){const t=new Promise(r=>{const t=()=>{e.removeEventListener("load",t),r()};e.addEventListener("load",t),e.complete&&0!==e.naturalWidth&&(e.removeEventListener("load",t),r())}),n=new Promise((e,t)=>{setTimeout(()=>{t(new RangeError(`failed to load the image, timeout of ${r} ms exceeded`))},r)});return Promise.race([t,n])},s=async function(e){return e instanceof HTMLImageElement?async function(e){return o(async()=>{await u(e);const r=function(e){const r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height),r}(e),t=i(r);return t})}(e):i(e)};function i(e){return e.getContext("2d").getImageData(0,0,e.width,e.height).data}class a{constructor(e){this.data=e}static async fromImageElement(o,u){const i=[],l=await s(o),c=4*(u-1);for(let o=c;o<l.length;o+=4+c){const u=new e([l[o+r],l[o+t],l[o+n]]);i.push(u)}return new a(i)}}const l=new class{constructor(e,r){this.begin=e,this.end=r}liesIn(e){return e>=this.begin&&e<=this.end}toString(){return`[${this.begin}, ${this.end}]`}}(1,25),c=8,m=1;function h(e){return e.imageElement||e.rgbImage?e.imageElement?async function(e){const r=function(e){const r=["imageElement","numberOfColors","quality"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{imageElement:t}=e;if(!(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement))return Promise.reject(new TypeError("imageElement property should be of type HTMLImageElement or HTMLCanvasElement"));if(t instanceof HTMLImageElement)return o(async()=>(await u(t),v(e)));return v(e)}(e):function(e){const r=function(e){const r=["rgbImage","numberOfColors","quality"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{rgbImage:t}=e;if(!(t instanceof a))return Promise.reject(new TypeError("image property should be of type RGBImage"));return v(e)}(e):Promise.reject(new RangeError("parameters argument should include either imageElement or rgbImage property"))}function v(e){const{numberOfColors:r=c,quality:t=m}=e;return Number.isInteger(r)?r>=1&&r<=256?Number.isInteger(t)?l.liesIn(t)?e.imageElement?Promise.resolve({imageElement:e.imageElement,numberOfColors:r,quality:t}):Promise.resolve({rgbImage:e.rgbImage,numberOfColors:r,quality:t}):Promise.reject(new RangeError(`quality property should lie in ${l.toString()}`)):Promise.reject(new TypeError("quality property should be an integer")):Promise.reject(new RangeError("numberOfColors property should lie in [1, 256]")):Promise.reject(new TypeError("numberOfColors property should be an integer"))}function g(e){return p(e,b)}function f(e){return p(e,T)}async function p(e,r){return o(async()=>{const t=await h(e),n=function(e,r){let t=[e.data];for(let e=0;e<r-1;e+=1){const e=d(t),r=H(e),n=y(e,r);t.splice(t.indexOf(e),1),t=t.concat(n)}return t}(await async function(e){return e.rgbImage?e.rgbImage:a.fromImageElement(e.imageElement,e.quality)}(t),t.numberOfColors);return r(n)})}function d(e){return e.reduce((e,r)=>r.length>e.length?r:e)}function H(e){class o{constructor(e){this.axis=e,this.minMax=[255,0]}updateMinMax(e){this.minMax=[Math.min(e,this.minMax[0]),Math.max(e,this.minMax[1])]}get width(){return this.minMax[1]-this.minMax[0]}}const u=[new o(r),new o(t),new o(n)];return e.forEach(e=>{u[r].updateMinMax(e.red),u[t].updateMinMax(e.green),u[n].updateMinMax(e.blue)}),u.reduce((e,r)=>r.width>e.width?r:e).axis}function y(e,r){return function(e,r,t){return e.reduce((e,n)=>(e[(e=>e.channels[r]<=t?0:1)(n)].push(n),e),[[],[]])}(e,r,function(e,r){const t=e.map(e=>e.channels[r]).sort((e,r)=>e-r);return t[Math.floor(t.length/2)-1]}(e,r))}function b(e){const r=e.map(e=>{const r=w(e);return e.map(e=>({sourceColor:e,representativeColor:r}))});return[].concat(...r)}function T(e){return e.map(e=>({color:w(e),population:e.length}))}function w(o){const u=o.reduce((e,o)=>[e[r]+o.red,e[t]+o.green,e[n]+o.blue],[0,0,0]).map(e=>Math.floor(e/o.length+.5));return new e([u[r],u[t],u[n]])}class E{constructor(e){this.channels=e}toString(){return this.channels.toString()}static fromString(e){const r=e.split(",").map(Number);return new E([r[0],r[1],r[2]])}get hue(){return this.channels[x]}get saturation(){return this.channels[L]}get lightness(){return this.channels[M]}}const x=0,L=1,M=2;var P=P||{};P.Geometry=function(){},P.Geometry.intersectLineLine=function(e,r){var t=(e.intercept-r.intercept)/(r.slope-e.slope);return{x:t,y:e.slope*t+e.intercept}},P.Geometry.distanceFromOrigin=function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},P.Geometry.distanceLineFromOrigin=function(e){return Math.abs(e.intercept)/Math.sqrt(Math.pow(e.slope,2)+1)},P.Geometry.perpendicularThroughPoint=function(e,r){var t=-1/e.slope;return{slope:t,intercept:r.y-t*r.x}},P.Geometry.angleFromOrigin=function(e){return Math.atan2(e.y,e.x)},P.Geometry.normalizeAngle=function(e){var r=2*Math.PI;return(e%r+r)%r},P.Geometry.lengthOfRayUntilIntersect=function(e,r){return r.intercept/(Math.sin(e)-r.slope*Math.cos(e))},P.Hsluv=function(){},P.Hsluv.getBounds=function(e){for(var r=[],t=Math.pow(e+16,3)/1560896,n=t>P.Hsluv.epsilon?t:e/P.Hsluv.kappa,o=0;o<3;)for(var u=o++,s=P.Hsluv.m[u][0],i=P.Hsluv.m[u][1],a=P.Hsluv.m[u][2],l=0;l<2;){var c=l++,m=(284517*s-94839*a)*n,h=(838422*a+769860*i+731718*s)*e*n-769860*c*e,v=(632260*a-126452*i)*n+126452*c;r.push({slope:m/v,intercept:h/v})}return r},P.Hsluv.maxSafeChromaForL=function(e){for(var r=P.Hsluv.getBounds(e),t=1/0,n=0;n<r.length;){var o=r[n];++n;var u=P.Geometry.distanceLineFromOrigin(o);t=Math.min(t,u)}return t},P.Hsluv.maxChromaForLH=function(e,r){for(var t=r/360*Math.PI*2,n=P.Hsluv.getBounds(e),o=1/0,u=0;u<n.length;){var s=n[u];++u;var i=P.Geometry.lengthOfRayUntilIntersect(t,s);i>=0&&(o=Math.min(o,i))}return o},P.Hsluv.dotProduct=function(e,r){for(var t=0,n=0,o=e.length;n<o;){var u=n++;t+=e[u]*r[u]}return t},P.Hsluv.fromLinear=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.4166666666666667)-.055},P.Hsluv.toLinear=function(e){return e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92},P.Hsluv.xyzToRgb=function(e){return[P.Hsluv.fromLinear(P.Hsluv.dotProduct(P.Hsluv.m[0],e)),P.Hsluv.fromLinear(P.Hsluv.dotProduct(P.Hsluv.m[1],e)),P.Hsluv.fromLinear(P.Hsluv.dotProduct(P.Hsluv.m[2],e))]},P.Hsluv.rgbToXyz=function(e){var r=[P.Hsluv.toLinear(e[0]),P.Hsluv.toLinear(e[1]),P.Hsluv.toLinear(e[2])];return[P.Hsluv.dotProduct(P.Hsluv.minv[0],r),P.Hsluv.dotProduct(P.Hsluv.minv[1],r),P.Hsluv.dotProduct(P.Hsluv.minv[2],r)]},P.Hsluv.yToL=function(e){return e<=P.Hsluv.epsilon?e/P.Hsluv.refY*P.Hsluv.kappa:116*Math.pow(e/P.Hsluv.refY,.3333333333333333)-16},P.Hsluv.lToY=function(e){return e<=8?P.Hsluv.refY*e/P.Hsluv.kappa:P.Hsluv.refY*Math.pow((e+16)/116,3)},P.Hsluv.xyzToLuv=function(e){var r=e[0],t=e[1],n=r+15*t+3*e[2],o=4*r,u=9*t;0!=n?(o/=n,u/=n):(o=NaN,u=NaN);var s=P.Hsluv.yToL(t);return 0==s?[0,0,0]:[s,13*s*(o-P.Hsluv.refU),13*s*(u-P.Hsluv.refV)]},P.Hsluv.luvToXyz=function(e){var r=e[0],t=e[1],n=e[2];if(0==r)return[0,0,0];var o=t/(13*r)+P.Hsluv.refU,u=n/(13*r)+P.Hsluv.refV,s=P.Hsluv.lToY(r),i=0-9*s*o/((o-4)*u-o*u);return[i,s,(9*s-15*u*s-u*i)/(3*u)]},P.Hsluv.luvToLch=function(e){var r,t=e[0],n=e[1],o=e[2],u=Math.sqrt(n*n+o*o);u<1e-8?r=0:(r=180*Math.atan2(o,n)/Math.PI)<0&&(r=360+r);return[t,u,r]},P.Hsluv.lchToLuv=function(e){var r=e[0],t=e[1],n=e[2]/360*2*Math.PI;return[r,Math.cos(n)*t,Math.sin(n)*t]},P.Hsluv.hsluvToLch=function(e){var r=e[0],t=e[1],n=e[2];return n>99.9999999?[100,0,r]:n<1e-8?[0,0,r]:[n,P.Hsluv.maxChromaForLH(n,r)/100*t,r]},P.Hsluv.lchToHsluv=function(e){var r=e[0],t=e[1],n=e[2];return r>99.9999999?[n,0,100]:r<1e-8?[n,0,0]:[n,t/P.Hsluv.maxChromaForLH(r,n)*100,r]},P.Hsluv.hpluvToLch=function(e){var r=e[0],t=e[1],n=e[2];return n>99.9999999?[100,0,r]:n<1e-8?[0,0,r]:[n,P.Hsluv.maxSafeChromaForL(n)/100*t,r]},P.Hsluv.lchToHpluv=function(e){var r=e[0],t=e[1],n=e[2];return r>99.9999999?[n,0,100]:r<1e-8?[n,0,0]:[n,t/P.Hsluv.maxSafeChromaForL(r)*100,r]},P.Hsluv.rgbToHex=function(e){for(var r="#",t=0;t<3;){var n=e[t++],o=Math.round(255*n),u=o%16,s=(o-u)/16|0;r+=P.Hsluv.hexChars.charAt(s)+P.Hsluv.hexChars.charAt(u)}return r},P.Hsluv.hexToRgb=function(e){e=e.toLowerCase();for(var r=[],t=0;t<3;){var n=t++,o=16*P.Hsluv.hexChars.indexOf(e.charAt(2*n+1))+P.Hsluv.hexChars.indexOf(e.charAt(2*n+2));r.push(o/255)}return r},P.Hsluv.lchToRgb=function(e){return P.Hsluv.xyzToRgb(P.Hsluv.luvToXyz(P.Hsluv.lchToLuv(e)))},P.Hsluv.rgbToLch=function(e){return P.Hsluv.luvToLch(P.Hsluv.xyzToLuv(P.Hsluv.rgbToXyz(e)))},P.Hsluv.hsluvToRgb=function(e){return P.Hsluv.lchToRgb(P.Hsluv.hsluvToLch(e))},P.Hsluv.rgbToHsluv=function(e){return P.Hsluv.lchToHsluv(P.Hsluv.rgbToLch(e))},P.Hsluv.hpluvToRgb=function(e){return P.Hsluv.lchToRgb(P.Hsluv.hpluvToLch(e))},P.Hsluv.rgbToHpluv=function(e){return P.Hsluv.lchToHpluv(P.Hsluv.rgbToLch(e))},P.Hsluv.hsluvToHex=function(e){return P.Hsluv.rgbToHex(P.Hsluv.hsluvToRgb(e))},P.Hsluv.hpluvToHex=function(e){return P.Hsluv.rgbToHex(P.Hsluv.hpluvToRgb(e))},P.Hsluv.hexToHsluv=function(e){return P.Hsluv.rgbToHsluv(P.Hsluv.hexToRgb(e))},P.Hsluv.hexToHpluv=function(e){return P.Hsluv.rgbToHpluv(P.Hsluv.hexToRgb(e))},P.Hsluv.m=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],P.Hsluv.minv=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],P.Hsluv.refY=1,P.Hsluv.refU=.19783000664283,P.Hsluv.refV=.46831999493879,P.Hsluv.kappa=903.2962962,P.Hsluv.epsilon=.0088564516,P.Hsluv.hexChars="0123456789abcdef";var I={hsluvToRgb:P.Hsluv.hsluvToRgb,rgbToHsluv:P.Hsluv.rgbToHsluv,hpluvToRgb:P.Hsluv.hpluvToRgb,rgbToHpluv:P.Hsluv.rgbToHpluv,hsluvToHex:P.Hsluv.hsluvToHex,hexToHsluv:P.Hsluv.hexToHsluv,hpluvToHex:P.Hsluv.hpluvToHex,hexToHpluv:P.Hsluv.hexToHpluv,lchToHpluv:P.Hsluv.lchToHpluv,hpluvToLch:P.Hsluv.hpluvToLch,lchToHsluv:P.Hsluv.lchToHsluv,hsluvToLch:P.Hsluv.hsluvToLch,lchToLuv:P.Hsluv.lchToLuv,luvToLch:P.Hsluv.luvToLch,xyzToLuv:P.Hsluv.xyzToLuv,luvToXyz:P.Hsluv.luvToXyz,xyzToRgb:P.Hsluv.xyzToRgb,rgbToXyz:P.Hsluv.rgbToXyz,lchToRgb:P.Hsluv.lchToRgb,rgbToLch:P.Hsluv.rgbToLch};function R(e){const r=e.channels.map(e=>e/255),t=I.rgbToHsluv(r);return new E(t)}class j{constructor(e){this.data=e}static async fromImageElement(o,u){const i=[],a=await s(o),l=4*(u-1);for(let o=l;o<a.length;o+=4+l){const u=[a[o+r],a[o+t],a[o+n]],s=R(new e(u));i.push(s)}return new j(i)}static fromRGBImage(r,t){const n=[],o=t-1;for(let t=o;t<r.data.length;t+=1+o){const o=[r.data[t].red,r.data[t].green,r.data[t].blue],u=R(new e(o));n.push(u)}return new j(n)}}const C=[15,20,20];var O=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},z=async function(e){const r=function(e){if(e.imageElement)return function(e){const r=["imageElement","numberOfColors","quality","regionSize"];return Object.keys(e).filter(e=>!r.includes(e))}(e);return function(e){const r=["rgbImage","numberOfColors","quality","regionSize"];return Object.keys(e).filter(e=>!r.includes(e))}(e)}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{regionSize:t=C}=e;if(3!==t.length)return Promise.reject(new TypeError("regionSize property should be of type [number, number, number]"));const[n,u,s]=t;return Number.isInteger(n)?n>=1&&n<=360?Number.isInteger(u)?u>=1&&u<=100?Number.isInteger(s)?s>=1&&s<=100?o(async()=>{const r=await function(e){if(e.imageElement){const{imageElement:r,numberOfColors:t,quality:n}=e;return h({imageElement:r,numberOfColors:t,quality:n})}const{rgbImage:r,numberOfColors:t,quality:n}=e;return h({rgbImage:r,numberOfColors:t,quality:n})}(e);return Promise.resolve(O({},r,{regionSize:t}))}):Promise.reject(new RangeError("lightness in regionSize property should lie in [1, 100]")):Promise.reject(new TypeError("lightness in regionSize property should be an integer")):Promise.reject(new RangeError("saturation in regionSize property should lie in [1, 100]")):Promise.reject(new TypeError("saturation in regionSize property should be an integer")):Promise.reject(new RangeError("hue in regionSize property should lie in [1, 360]")):Promise.reject(new TypeError("hue in regionSize property should be an integer"))};function q(e,r){let t=0;for(;r>=e[t]&&t<e.length;)t+=1;return[e[t-1],e[t]].toString()}var S=async function(r){return o(async()=>{const o=await z(r),s=await async function(e){return e.rgbImage?j.fromRGBImage(e.rgbImage,e.quality):j.fromImageElement(e.imageElement,e.quality)}(o);return t=s,n=o.regionSize,u=o.numberOfColors,function(r,t){return function(e,r){const t=e.map(e=>({regionID:e[0],population:F(e[1])}));t.sort((e,r)=>r.population-e.population);const n=t.slice(0,r).map(e=>e.regionID);return e.filter(e=>n.includes(e[0]))}(r,t).map(r=>(function(r){return{color:function(r){const t=I.hsluvToRgb(r.channels).map(e=>Math.floor(255*e+.5));return new e(t)}(r.map(e=>({color:E.fromString(e[0]),population:e[1]})).reduce((e,r)=>r.population>e.population?r:e).color),population:F(r)}})(r[1]))}(function(e,r){const t=new Map;return e.data.forEach(e=>{const n=function(e,r){const t=[];for(let e=0;e<360+r[x];e+=r[x])t.push(Math.min(e,360));const n=[];for(let e=0;e<100+r[L];e+=r[L])n.push(Math.min(e,100));const o=[];for(let e=0;e<100+r[M];e+=r[M])o.push(Math.min(e,100));return[q(t,e.hue),q(n,e.saturation),q(o,e.lightness)].join(",")}(e,r),o=e.toString(),u=t.get(n);if(u){const e=u.get(o);e?u.set(o,e+1):u.set(o,1)}else t.set(n,new Map([[o,1]]))}),Array.from(t.entries()).map(e=>[e[0],Array.from(e[1].entries()).map(e=>[e[0],e[1]])])}(t,n),u)});var t,n,u};function F(e){return e.reduce((e,r)=>e+r[1],0)}class B{constructor(){this.values=[],this.settlers=[],this.closed=!1}enqueue(e){if(this.closed)throw new Error("unable to enqueue a task onto a closed queue");if(0===this.settlers.length)this.values.push(e);else{const r=this.settlers.shift();e instanceof Error?r.reject(e):r.resolve({done:!1,value:e})}}[Symbol.asyncIterator](){return this}next(){if(this.values.length>0){const e=this.values.shift();return e instanceof Error?Promise.reject(e):Promise.resolve({done:!1,value:e})}return this.closed?Promise.resolve({done:!0}):new Promise((e,r)=>{this.settlers.push({resolve:e,reject:r})})}close(){if(this.settlers.length>0){this.settlers.shift().resolve({done:!0})}this.closed=!0}}function k(e,r=2e3){const t=new Promise(r=>{const t=()=>{e.removeEventListener("loadeddata",t),r()};e.addEventListener("loadeddata",t),4===e.readyState&&(e.removeEventListener("loadeddata",t),r())}),n=new Promise((e,t)=>{setTimeout(()=>{t(new RangeError(`failed to load the video, timeout of ${r} ms exceeded`))},r)});return Promise.race([t,n])}const G=1;var N=async function(e){const r=function(e){const r=["videoElement","secondsBetweenFrames"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{videoElement:t,secondsBetweenFrames:n=G}=e;if(!t)return Promise.reject(new RangeError("parameters argument should include videoElement property"));if(!(t instanceof HTMLVideoElement))return Promise.reject(new TypeError("videoElement property should be of type HTMLVideoElement"));try{await k(t)}catch(e){return Promise.reject(e)}return 0===t.width?Promise.reject(new RangeError("width attribute in videoElement property is 0")):0===t.height?Promise.reject(new RangeError("height attribute in videoElement property is 0")):Number.isFinite(n)?n<=0?Promise.reject(new RangeError("secondsBetweenFrames property should be greater than 0")):Promise.resolve({videoElement:t,secondsBetweenFrames:n}):Promise.reject(new TypeError("secondsBetweenFrames property should be a number"))};var $=async function*(e,r){try{yield*async function*(e,r){const t=new B,n=e.videoElement.cloneNode();try{n.preload="auto",await k(n)}catch(e){throw e}let o=0,u=1;n.currentTime=o;const s=async()=>{const i=function(e){const r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height),r}(n);let a;try{a=await r(i)}catch(e){a=e}t.enqueue({index:u,timestamp:o,result:a}),o+=e.secondsBetweenFrames,u+=1,o<=n.duration?n.currentTime=o:(t.close(),n.removeEventListener("seeked",s))};await s(),n.addEventListener("seeked",s),yield*async function*e(r){const t=await r.next();t.done||(yield t.value,yield*e(r))}(t)}(await N(e),r)}catch(e){throw e}};function V(e){const{videoElement:r,secondsBetweenFrames:t,numberOfColors:n,quality:o}=e;return[{videoElement:r,secondsBetweenFrames:t},{numberOfColors:n,quality:o}]}return O({RGBImage:a},{quantizeImage:g,reduceImage:f,popularizeImage:S},{quantizeVideo:function(e){const[r,t]=V(e);return $(r,e=>g(O({imageElement:e},t)))},reduceVideo:function(e){const[r,t]=V(e);return $(r,e=>f(O({imageElement:e},t)))},popularizeVideo:function(e){const[r,t]=function(e){const{videoElement:r,secondsBetweenFrames:t,numberOfColors:n,quality:o,regionSize:u}=e;return[{videoElement:r,secondsBetweenFrames:t},{numberOfColors:n,quality:o,regionSize:u}]}(e);return $(r,e=>S(O({imageElement:e},t)))}})});
