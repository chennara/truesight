/*!
 * truesight.min.js v0.1.0-alpha.1
 * Copyright (c) 2018-present, Chennara Nhes.
 * Released under the MIT License.
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.truesight=r()}(this,function(){"use strict";var e=e||{};e.Geometry=function(){},e.Geometry.intersectLineLine=function(e,r){var t=(e.intercept-r.intercept)/(r.slope-e.slope);return{x:t,y:e.slope*t+e.intercept}},e.Geometry.distanceFromOrigin=function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},e.Geometry.distanceLineFromOrigin=function(e){return Math.abs(e.intercept)/Math.sqrt(Math.pow(e.slope,2)+1)},e.Geometry.perpendicularThroughPoint=function(e,r){var t=-1/e.slope;return{slope:t,intercept:r.y-t*r.x}},e.Geometry.angleFromOrigin=function(e){return Math.atan2(e.y,e.x)},e.Geometry.normalizeAngle=function(e){var r=2*Math.PI;return(e%r+r)%r},e.Geometry.lengthOfRayUntilIntersect=function(e,r){return r.intercept/(Math.sin(e)-r.slope*Math.cos(e))},e.Hsluv=function(){},e.Hsluv.getBounds=function(r){for(var t=[],n=Math.pow(r+16,3)/1560896,o=n>e.Hsluv.epsilon?n:r/e.Hsluv.kappa,u=0;u<3;)for(var s=u++,i=e.Hsluv.m[s][0],l=e.Hsluv.m[s][1],a=e.Hsluv.m[s][2],c=0;c<2;){var m=c++,h=(284517*i-94839*a)*o,v=(838422*a+769860*l+731718*i)*r*o-769860*m*r,g=(632260*a-126452*l)*o+126452*m;t.push({slope:h/g,intercept:v/g})}return t},e.Hsluv.maxSafeChromaForL=function(r){for(var t=e.Hsluv.getBounds(r),n=1/0,o=0;o<t.length;){var u=t[o];++o;var s=e.Geometry.distanceLineFromOrigin(u);n=Math.min(n,s)}return n},e.Hsluv.maxChromaForLH=function(r,t){for(var n=t/360*Math.PI*2,o=e.Hsluv.getBounds(r),u=1/0,s=0;s<o.length;){var i=o[s];++s;var l=e.Geometry.lengthOfRayUntilIntersect(n,i);l>=0&&(u=Math.min(u,l))}return u},e.Hsluv.dotProduct=function(e,r){for(var t=0,n=0,o=e.length;n<o;){var u=n++;t+=e[u]*r[u]}return t},e.Hsluv.fromLinear=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.4166666666666667)-.055},e.Hsluv.toLinear=function(e){return e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92},e.Hsluv.xyzToRgb=function(r){return[e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[0],r)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[1],r)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[2],r))]},e.Hsluv.rgbToXyz=function(r){var t=[e.Hsluv.toLinear(r[0]),e.Hsluv.toLinear(r[1]),e.Hsluv.toLinear(r[2])];return[e.Hsluv.dotProduct(e.Hsluv.minv[0],t),e.Hsluv.dotProduct(e.Hsluv.minv[1],t),e.Hsluv.dotProduct(e.Hsluv.minv[2],t)]},e.Hsluv.yToL=function(r){return r<=e.Hsluv.epsilon?r/e.Hsluv.refY*e.Hsluv.kappa:116*Math.pow(r/e.Hsluv.refY,.3333333333333333)-16},e.Hsluv.lToY=function(r){return r<=8?e.Hsluv.refY*r/e.Hsluv.kappa:e.Hsluv.refY*Math.pow((r+16)/116,3)},e.Hsluv.xyzToLuv=function(r){var t=r[0],n=r[1],o=t+15*n+3*r[2],u=4*t,s=9*n;0!=o?(u/=o,s/=o):(u=NaN,s=NaN);var i=e.Hsluv.yToL(n);return 0==i?[0,0,0]:[i,13*i*(u-e.Hsluv.refU),13*i*(s-e.Hsluv.refV)]},e.Hsluv.luvToXyz=function(r){var t=r[0],n=r[1],o=r[2];if(0==t)return[0,0,0];var u=n/(13*t)+e.Hsluv.refU,s=o/(13*t)+e.Hsluv.refV,i=e.Hsluv.lToY(t),l=0-9*i*u/((u-4)*s-u*s);return[l,i,(9*i-15*s*i-s*l)/(3*s)]},e.Hsluv.luvToLch=function(e){var r,t=e[0],n=e[1],o=e[2],u=Math.sqrt(n*n+o*o);u<1e-8?r=0:(r=180*Math.atan2(o,n)/Math.PI)<0&&(r=360+r);return[t,u,r]},e.Hsluv.lchToLuv=function(e){var r=e[0],t=e[1],n=e[2]/360*2*Math.PI;return[r,Math.cos(n)*t,Math.sin(n)*t]},e.Hsluv.hsluvToLch=function(r){var t=r[0],n=r[1],o=r[2];return o>99.9999999?[100,0,t]:o<1e-8?[0,0,t]:[o,e.Hsluv.maxChromaForLH(o,t)/100*n,t]},e.Hsluv.lchToHsluv=function(r){var t=r[0],n=r[1],o=r[2];return t>99.9999999?[o,0,100]:t<1e-8?[o,0,0]:[o,n/e.Hsluv.maxChromaForLH(t,o)*100,t]},e.Hsluv.hpluvToLch=function(r){var t=r[0],n=r[1],o=r[2];return o>99.9999999?[100,0,t]:o<1e-8?[0,0,t]:[o,e.Hsluv.maxSafeChromaForL(o)/100*n,t]},e.Hsluv.lchToHpluv=function(r){var t=r[0],n=r[1],o=r[2];return t>99.9999999?[o,0,100]:t<1e-8?[o,0,0]:[o,n/e.Hsluv.maxSafeChromaForL(t)*100,t]},e.Hsluv.rgbToHex=function(r){for(var t="#",n=0;n<3;){var o=r[n++],u=Math.round(255*o),s=u%16,i=(u-s)/16|0;t+=e.Hsluv.hexChars.charAt(i)+e.Hsluv.hexChars.charAt(s)}return t},e.Hsluv.hexToRgb=function(r){r=r.toLowerCase();for(var t=[],n=0;n<3;){var o=n++,u=16*e.Hsluv.hexChars.indexOf(r.charAt(2*o+1))+e.Hsluv.hexChars.indexOf(r.charAt(2*o+2));t.push(u/255)}return t},e.Hsluv.lchToRgb=function(r){return e.Hsluv.xyzToRgb(e.Hsluv.luvToXyz(e.Hsluv.lchToLuv(r)))},e.Hsluv.rgbToLch=function(r){return e.Hsluv.luvToLch(e.Hsluv.xyzToLuv(e.Hsluv.rgbToXyz(r)))},e.Hsluv.hsluvToRgb=function(r){return e.Hsluv.lchToRgb(e.Hsluv.hsluvToLch(r))},e.Hsluv.rgbToHsluv=function(r){return e.Hsluv.lchToHsluv(e.Hsluv.rgbToLch(r))},e.Hsluv.hpluvToRgb=function(r){return e.Hsluv.lchToRgb(e.Hsluv.hpluvToLch(r))},e.Hsluv.rgbToHpluv=function(r){return e.Hsluv.lchToHpluv(e.Hsluv.rgbToLch(r))},e.Hsluv.hsluvToHex=function(r){return e.Hsluv.rgbToHex(e.Hsluv.hsluvToRgb(r))},e.Hsluv.hpluvToHex=function(r){return e.Hsluv.rgbToHex(e.Hsluv.hpluvToRgb(r))},e.Hsluv.hexToHsluv=function(r){return e.Hsluv.rgbToHsluv(e.Hsluv.hexToRgb(r))},e.Hsluv.hexToHpluv=function(r){return e.Hsluv.rgbToHpluv(e.Hsluv.hexToRgb(r))},e.Hsluv.m=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],e.Hsluv.minv=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],e.Hsluv.refY=1,e.Hsluv.refU=.19783000664283,e.Hsluv.refV=.46831999493879,e.Hsluv.kappa=903.2962962,e.Hsluv.epsilon=.0088564516,e.Hsluv.hexChars="0123456789abcdef";var r={hsluvToRgb:e.Hsluv.hsluvToRgb,rgbToHsluv:e.Hsluv.rgbToHsluv,hpluvToRgb:e.Hsluv.hpluvToRgb,rgbToHpluv:e.Hsluv.rgbToHpluv,hsluvToHex:e.Hsluv.hsluvToHex,hexToHsluv:e.Hsluv.hexToHsluv,hpluvToHex:e.Hsluv.hpluvToHex,hexToHpluv:e.Hsluv.hexToHpluv,lchToHpluv:e.Hsluv.lchToHpluv,hpluvToLch:e.Hsluv.hpluvToLch,lchToHsluv:e.Hsluv.lchToHsluv,hsluvToLch:e.Hsluv.hsluvToLch,lchToLuv:e.Hsluv.lchToLuv,luvToLch:e.Hsluv.luvToLch,xyzToLuv:e.Hsluv.xyzToLuv,luvToXyz:e.Hsluv.luvToXyz,xyzToRgb:e.Hsluv.xyzToRgb,rgbToXyz:e.Hsluv.rgbToXyz,lchToRgb:e.Hsluv.lchToRgb,rgbToLch:e.Hsluv.rgbToLch};class t{constructor(e){this.channels=e}toString(){return this.channels.toString()}toRGBColor(){const e=r.hsluvToRgb(this.channels).map(e=>Math.floor(255*e+.5));return new s(e)}static fromString(e){const r=e.split(",").map(Number);return new t([r[0],r[1],r[2]])}get hue(){return this.channels[n]}get saturation(){return this.channels[o]}get lightness(){return this.channels[u]}}const n=0,o=1,u=2;class s{constructor(e){this.channels=e}toHSLuvColor(){const e=this.channels.map(e=>e/255),n=r.rgbToHsluv(e);return new t(n)}get red(){return this.channels[i]}get green(){return this.channels[l]}get blue(){return this.channels[a]}}const i=0,l=1,a=2;var c=async function(e,r=2e3){const t=new Promise(r=>{const t=()=>{r(),e.removeEventListener("load",t)};e.addEventListener("load",t),e.complete&&0!==e.naturalWidth&&(r(),e.removeEventListener("load",t))}),n=new Promise((e,t)=>{setTimeout(()=>{t(new RangeError(`failed to load the image, timeout of ${r} ms exceeded`))},r)});return Promise.race([t,n])},m=async function(e){return e instanceof HTMLImageElement?async function(e){try{await c(e)}catch(e){return Promise.reject(e)}return h(function(e){const r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height),r}(e))}(e):h(e)};function h(e){return e.getContext("2d").getImageData(0,0,e.width,e.height).data}class v{constructor(e){this.data=e}static async fromImageElement(e,r){const t=[],n=await m(e),o=4*(r-1);for(let e=o;e<n.length;e+=4+o){const r=new s([n[e+i],n[e+l],n[e+a]]);t.push(r)}return new v(t)}}const g=new class{constructor(e,r){this.begin=e,this.end=r}liesIn(e){return e>=this.begin&&e<=this.end}toString(){return`[${this.begin}, ${this.end}]`}}(1,25),f=8,p=1;function d(e){return e.imageElement||e.rgbImage?e.imageElement?async function(e){const r=function(e){const r=["imageElement","numberOfColors","quality"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{imageElement:t}=e;if(!(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement))return Promise.reject(new TypeError("imageElement property should be of type HTMLImageElement or HTMLCanvasElement"));if(t instanceof HTMLImageElement)try{await c(t)}catch(e){return Promise.reject(e)}return H(e)}(e):function(e){const r=function(e){const r=["rgbImage","numberOfColors","quality"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{rgbImage:t}=e;if(!(t instanceof v))return Promise.reject(new TypeError("image property should be of type RGBImage"));return H(e)}(e):Promise.reject(new RangeError("parameters argument should include either imageElement or rgbImage property"))}function H(e){const{numberOfColors:r=f,quality:t=p}=e;return Number.isInteger(r)?r>=1&&r<=256?Number.isInteger(t)?g.liesIn(t)?e.imageElement?Promise.resolve({imageElement:e.imageElement,numberOfColors:r,quality:t}):Promise.resolve({rgbImage:e.rgbImage,numberOfColors:r,quality:t}):Promise.reject(new RangeError(`quality property should lie in ${g.toString()}`)):Promise.reject(new TypeError("quality property should be an integer")):Promise.reject(new RangeError("numberOfColors property should lie in [1, 256]")):Promise.reject(new TypeError("numberOfColors property should be an integer"))}function y(e){return T(e,L)}function b(e){return T(e,M)}async function T(e,r){try{const t=await d(e);return r(function(e,r){let t=[e.data];for(let e=0;e<r-1;e+=1){const e=w(t),r=E(e),n=x(e,r);t.splice(t.indexOf(e),1),t=t.concat(n)}return t}(await async function(e){return e.rgbImage?e.rgbImage:v.fromImageElement(e.imageElement,e.quality)}(t),t.numberOfColors))}catch(e){return Promise.reject(e)}}function w(e){return e.reduce((e,r)=>r.length>e.length?r:e)}function E(e){class r{constructor(e){this.axis=e,this.minMax=[255,0]}updateMinMax(e){this.minMax=[Math.min(e,this.minMax[0]),Math.max(e,this.minMax[1])]}get width(){return this.minMax[1]-this.minMax[0]}}const t=[new r(i),new r(l),new r(a)];return e.forEach(e=>{t[i].updateMinMax(e.red),t[l].updateMinMax(e.green),t[a].updateMinMax(e.blue)}),t.reduce((e,r)=>r.width>e.width?r:e).axis}function x(e,r){return function(e,r,t){return e.reduce((e,n)=>(e[(e=>e.channels[r]<=t?0:1)(n)].push(n),e),[[],[]])}(e,r,function(e,r){const t=e.map(e=>e.channels[r]).sort((e,r)=>e-r);return t[Math.floor(t.length/2)-1]}(e,r))}function L(e){const r=e.map(e=>{const r=P(e);return e.map(e=>({sourceColor:e,representativeColor:r}))});return[].concat(...r)}function M(e){return e.map(e=>({color:P(e),population:e.length}))}function P(e){const r=e.reduce((e,r)=>[e[i]+r.red,e[l]+r.green,e[a]+r.blue],[0,0,0]).map(r=>Math.floor(r/e.length+.5));return new s([r[i],r[l],r[a]])}class I{constructor(e){this.data=e}static fromRGBImage(e,r){const t=[],n=r-1;for(let r=n;r<e.data.length;r+=1+n){const n=[e.data[r].red,e.data[r].green,e.data[r].blue],o=new s(n).toHSLuvColor();t.push(o)}return new I(t)}static async fromImageElement(e,r){const t=[],n=await m(e),o=4*(r-1);for(let e=o;e<n.length;e+=4+o){const r=[n[e+i],n[e+l],n[e+a]],o=new s(r).toHSLuvColor();t.push(o)}return new I(t)}}const R=[15,20,20];var C=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},j=async function(e){const r=function(e){if(e.imageElement)return function(e){const r=["imageElement","numberOfColors","quality","regionSize"];return Object.keys(e).filter(e=>!r.includes(e))}(e);return function(e){const r=["rgbImage","numberOfColors","quality","regionSize"];return Object.keys(e).filter(e=>!r.includes(e))}(e)}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{regionSize:t=R}=e;if(3!==t.length)return Promise.reject(new TypeError("regionSize property should be of type [number, number, number]"));const[n,o,u]=t;if(!Number.isInteger(n))return Promise.reject(new TypeError("hue in regionSize property should be an integer"));if(!(n>=1&&n<=360))return Promise.reject(new RangeError("hue in regionSize property should lie in [1, 360]"));if(!Number.isInteger(o))return Promise.reject(new TypeError("saturation in regionSize property should be an integer"));if(!(o>=1&&o<=100))return Promise.reject(new RangeError("saturation in regionSize property should lie in [1, 100]"));if(!Number.isInteger(u))return Promise.reject(new TypeError("lightness in regionSize property should be an integer"));if(!(u>=1&&u<=100))return Promise.reject(new RangeError("lightness in regionSize property should lie in [1, 100]"));try{const r=await function(e){if(e.imageElement){const{imageElement:r,numberOfColors:t,quality:n}=e;return d({imageElement:r,numberOfColors:t,quality:n})}const{rgbImage:r,numberOfColors:t,quality:n}=e;return d({rgbImage:r,numberOfColors:t,quality:n})}(e);return Promise.resolve(C({},r,{regionSize:t}))}catch(e){return Promise.reject(e)}};function O(e,r){let t=0;for(;r>=e[t]&&t<e.length;)t+=1;return[e[t-1],e[t]].toString()}var z=async function(e){try{const l=await j(e),a=await async function(e){return e.rgbImage?I.fromRGBImage(e.rgbImage,e.quality):I.fromImageElement(e.imageElement,e.quality)}(l);return r=a,s=l.regionSize,i=l.numberOfColors,function(e,r){return function(e,r){const t=e.map(e=>({regionID:e[0],population:S(e[1])}));t.sort((e,r)=>r.population-e.population);const n=t.slice(0,r).map(e=>e.regionID);return e.filter(e=>n.includes(e[0]))}(e,r).map(e=>(function(e){return{color:e.map(e=>({color:t.fromString(e[0]),population:e[1]})).reduce((e,r)=>r.population>e.population?r:e).color.toRGBColor(),population:S(e)}})(e[1]))}(function(e,r){const t=new Map;return e.data.forEach(e=>{const s=function(e,r){const t=[];for(let e=0;e<360+r[n];e+=r[n])t.push(Math.min(e,360));const s=[];for(let e=0;e<100+r[o];e+=r[o])s.push(Math.min(e,100));const i=[];for(let e=0;e<100+r[u];e+=r[u])i.push(Math.min(e,100));return[O(t,e.hue),O(s,e.saturation),O(i,e.lightness)].join(",")}(e,r),i=e.toString(),l=t.get(s);if(l){const e=l.get(i);e?l.set(i,e+1):l.set(i,1)}else t.set(s,new Map([[i,1]]))}),Array.from(t.entries()).map(e=>[e[0],Array.from(e[1].entries()).map(e=>[e[0],e[1]])])}(r,s),i)}catch(e){return Promise.reject(e)}var r,s,i};function S(e){return e.reduce((e,r)=>e+r[1],0)}class q{constructor(){this.values=[],this.settlers=[],this.closed=!1}enqueue(e){if(this.closed)throw new Error("unable to enqueue a task onto a closed queue");if(0===this.settlers.length)this.values.push(e);else{const r=this.settlers.shift();e instanceof Error?r.reject(e):r.resolve({done:!1,value:e})}}[Symbol.asyncIterator](){return this}next(){if(this.values.length>0){const e=this.values.shift();return e instanceof Error?Promise.reject(e):Promise.resolve({done:!1,value:e})}return this.closed?Promise.resolve({done:!0}):new Promise((e,r)=>{this.settlers.push({resolve:e,reject:r})})}close(){if(this.settlers.length>0){this.settlers.shift().resolve({done:!0})}this.closed=!0}}function F(e,r=2e3){const t=new Promise(r=>{const t=()=>{r(),e.removeEventListener("loadeddata",t)};e.addEventListener("loadeddata",t),4===e.readyState&&(r(),e.removeEventListener("loadeddata",t))}),n=new Promise((e,t)=>{setTimeout(()=>{t(new RangeError(`failed to load the video, timeout of ${r} ms exceeded`))},r)});return Promise.race([t,n])}const B=1;var k=async function(e){const r=function(e){const r=["videoElement","secondsBetweenFrames"];return Object.keys(e).filter(e=>!r.includes(e))}(e);if(0!==r.length)return Promise.reject(new RangeError(`parameters argument includes unknown property ${r[0]}`));const{videoElement:t,secondsBetweenFrames:n=B}=e;if(!t)return Promise.reject(new RangeError("parameters argument should include videoElement property"));if(!(t instanceof HTMLVideoElement))return Promise.reject(new TypeError("videoElement property should be of type HTMLVideoElement"));try{await F(t)}catch(e){return Promise.reject(e)}return 0===t.width?Promise.reject(new RangeError("width attribute in videoElement property is 0")):0===t.height?Promise.reject(new RangeError("height attribute in videoElement property is 0")):Number.isFinite(n)?n<=0?Promise.reject(new RangeError("secondsBetweenFrames property should be greater than 0")):Promise.resolve({videoElement:t,secondsBetweenFrames:n}):Promise.reject(new TypeError("secondsBetweenFrames property should be a number"))};var G=async function*(e,r){try{yield*async function*(e,r){const t=new q,n=e.videoElement.cloneNode();try{n.preload="auto",await F(n)}catch(e){throw e}let o=0,u=1;n.currentTime=o;const s=async()=>{const i=function(e){const r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height),r}(n);let l;try{l=await r(i)}catch(e){l=e}t.enqueue({index:u,timestamp:o,result:l}),o+=e.secondsBetweenFrames,u+=1,o<=n.duration?n.currentTime=o:(t.close(),n.removeEventListener("seeked",s))};await s(),n.addEventListener("seeked",s),yield*async function*e(r){const t=await r.next();t.done||(yield t.value,yield*e(r))}(t)}(await k(e),r)}catch(e){throw e}};function N(e){const{videoElement:r,secondsBetweenFrames:t,numberOfColors:n,quality:o}=e;return[{videoElement:r,secondsBetweenFrames:t},{numberOfColors:n,quality:o}]}return C({RGBImage:v},{quantizeImage:y,reduceImage:b,popularizeImage:z},{quantizeVideo:function(e){const[r,t]=N(e);return G(r,e=>y(C({imageElement:e},t)))},reduceVideo:function(e){const[r,t]=N(e);return G(r,e=>b(C({imageElement:e},t)))},popularizeVideo:function(e){const[r,t]=function(e){const{videoElement:r,secondsBetweenFrames:t,numberOfColors:n,quality:o,regionSize:u}=e;return[{videoElement:r,secondsBetweenFrames:t},{numberOfColors:n,quality:o,regionSize:u}]}(e);return G(r,e=>z(C({imageElement:e},t)))}})});
