/*!
 * truesight.min.js v0.1.0-alpha.1
 * Copyright (c) 2018-present, Chennara Nhes.
 * Released under the MIT License.
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.truesight=n()}(this,function(){"use strict";var e=e||{};e.Geometry=function(){},e.Geometry.intersectLineLine=function(e,n){var r=(e.intercept-n.intercept)/(n.slope-e.slope);return{x:r,y:e.slope*r+e.intercept}},e.Geometry.distanceFromOrigin=function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},e.Geometry.distanceLineFromOrigin=function(e){return Math.abs(e.intercept)/Math.sqrt(Math.pow(e.slope,2)+1)},e.Geometry.perpendicularThroughPoint=function(e,n){var r=-1/e.slope;return{slope:r,intercept:n.y-r*n.x}},e.Geometry.angleFromOrigin=function(e){return Math.atan2(e.y,e.x)},e.Geometry.normalizeAngle=function(e){var n=2*Math.PI;return(e%n+n)%n},e.Geometry.lengthOfRayUntilIntersect=function(e,n){return n.intercept/(Math.sin(e)-n.slope*Math.cos(e))},e.Hsluv=function(){},e.Hsluv.getBounds=function(n){for(var r=[],t=Math.pow(n+16,3)/1560896,o=t>e.Hsluv.epsilon?t:n/e.Hsluv.kappa,u=0;u<3;)for(var s=u++,l=e.Hsluv.m[s][0],i=e.Hsluv.m[s][1],a=e.Hsluv.m[s][2],c=0;c<2;){var v=c++,h=(284517*l-94839*a)*o,m=(838422*a+769860*i+731718*l)*n*o-769860*v*n,g=(632260*a-126452*i)*o+126452*v;r.push({slope:h/g,intercept:m/g})}return r},e.Hsluv.maxSafeChromaForL=function(n){for(var r=e.Hsluv.getBounds(n),t=1/0,o=0;o<r.length;){var u=r[o];++o;var s=e.Geometry.distanceLineFromOrigin(u);t=Math.min(t,s)}return t},e.Hsluv.maxChromaForLH=function(n,r){for(var t=r/360*Math.PI*2,o=e.Hsluv.getBounds(n),u=1/0,s=0;s<o.length;){var l=o[s];++s;var i=e.Geometry.lengthOfRayUntilIntersect(t,l);i>=0&&(u=Math.min(u,i))}return u},e.Hsluv.dotProduct=function(e,n){for(var r=0,t=0,o=e.length;t<o;){var u=t++;r+=e[u]*n[u]}return r},e.Hsluv.fromLinear=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.4166666666666667)-.055},e.Hsluv.toLinear=function(e){return e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92},e.Hsluv.xyzToRgb=function(n){return[e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[0],n)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[1],n)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[2],n))]},e.Hsluv.rgbToXyz=function(n){var r=[e.Hsluv.toLinear(n[0]),e.Hsluv.toLinear(n[1]),e.Hsluv.toLinear(n[2])];return[e.Hsluv.dotProduct(e.Hsluv.minv[0],r),e.Hsluv.dotProduct(e.Hsluv.minv[1],r),e.Hsluv.dotProduct(e.Hsluv.minv[2],r)]},e.Hsluv.yToL=function(n){return n<=e.Hsluv.epsilon?n/e.Hsluv.refY*e.Hsluv.kappa:116*Math.pow(n/e.Hsluv.refY,.3333333333333333)-16},e.Hsluv.lToY=function(n){return n<=8?e.Hsluv.refY*n/e.Hsluv.kappa:e.Hsluv.refY*Math.pow((n+16)/116,3)},e.Hsluv.xyzToLuv=function(n){var r=n[0],t=n[1],o=r+15*t+3*n[2],u=4*r,s=9*t;0!=o?(u/=o,s/=o):(u=NaN,s=NaN);var l=e.Hsluv.yToL(t);return 0==l?[0,0,0]:[l,13*l*(u-e.Hsluv.refU),13*l*(s-e.Hsluv.refV)]},e.Hsluv.luvToXyz=function(n){var r=n[0],t=n[1],o=n[2];if(0==r)return[0,0,0];var u=t/(13*r)+e.Hsluv.refU,s=o/(13*r)+e.Hsluv.refV,l=e.Hsluv.lToY(r),i=0-9*l*u/((u-4)*s-u*s);return[i,l,(9*l-15*s*l-s*i)/(3*s)]},e.Hsluv.luvToLch=function(e){var n,r=e[0],t=e[1],o=e[2],u=Math.sqrt(t*t+o*o);u<1e-8?n=0:(n=180*Math.atan2(o,t)/Math.PI)<0&&(n=360+n);return[r,u,n]},e.Hsluv.lchToLuv=function(e){var n=e[0],r=e[1],t=e[2]/360*2*Math.PI;return[n,Math.cos(t)*r,Math.sin(t)*r]},e.Hsluv.hsluvToLch=function(n){var r=n[0],t=n[1],o=n[2];return o>99.9999999?[100,0,r]:o<1e-8?[0,0,r]:[o,e.Hsluv.maxChromaForLH(o,r)/100*t,r]},e.Hsluv.lchToHsluv=function(n){var r=n[0],t=n[1],o=n[2];return r>99.9999999?[o,0,100]:r<1e-8?[o,0,0]:[o,t/e.Hsluv.maxChromaForLH(r,o)*100,r]},e.Hsluv.hpluvToLch=function(n){var r=n[0],t=n[1],o=n[2];return o>99.9999999?[100,0,r]:o<1e-8?[0,0,r]:[o,e.Hsluv.maxSafeChromaForL(o)/100*t,r]},e.Hsluv.lchToHpluv=function(n){var r=n[0],t=n[1],o=n[2];return r>99.9999999?[o,0,100]:r<1e-8?[o,0,0]:[o,t/e.Hsluv.maxSafeChromaForL(r)*100,r]},e.Hsluv.rgbToHex=function(n){for(var r="#",t=0;t<3;){var o=n[t++],u=Math.round(255*o),s=u%16,l=(u-s)/16|0;r+=e.Hsluv.hexChars.charAt(l)+e.Hsluv.hexChars.charAt(s)}return r},e.Hsluv.hexToRgb=function(n){n=n.toLowerCase();for(var r=[],t=0;t<3;){var o=t++,u=16*e.Hsluv.hexChars.indexOf(n.charAt(2*o+1))+e.Hsluv.hexChars.indexOf(n.charAt(2*o+2));r.push(u/255)}return r},e.Hsluv.lchToRgb=function(n){return e.Hsluv.xyzToRgb(e.Hsluv.luvToXyz(e.Hsluv.lchToLuv(n)))},e.Hsluv.rgbToLch=function(n){return e.Hsluv.luvToLch(e.Hsluv.xyzToLuv(e.Hsluv.rgbToXyz(n)))},e.Hsluv.hsluvToRgb=function(n){return e.Hsluv.lchToRgb(e.Hsluv.hsluvToLch(n))},e.Hsluv.rgbToHsluv=function(n){return e.Hsluv.lchToHsluv(e.Hsluv.rgbToLch(n))},e.Hsluv.hpluvToRgb=function(n){return e.Hsluv.lchToRgb(e.Hsluv.hpluvToLch(n))},e.Hsluv.rgbToHpluv=function(n){return e.Hsluv.lchToHpluv(e.Hsluv.rgbToLch(n))},e.Hsluv.hsluvToHex=function(n){return e.Hsluv.rgbToHex(e.Hsluv.hsluvToRgb(n))},e.Hsluv.hpluvToHex=function(n){return e.Hsluv.rgbToHex(e.Hsluv.hpluvToRgb(n))},e.Hsluv.hexToHsluv=function(n){return e.Hsluv.rgbToHsluv(e.Hsluv.hexToRgb(n))},e.Hsluv.hexToHpluv=function(n){return e.Hsluv.rgbToHpluv(e.Hsluv.hexToRgb(n))},e.Hsluv.m=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],e.Hsluv.minv=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],e.Hsluv.refY=1,e.Hsluv.refU=.19783000664283,e.Hsluv.refV=.46831999493879,e.Hsluv.kappa=903.2962962,e.Hsluv.epsilon=.0088564516,e.Hsluv.hexChars="0123456789abcdef";var n={hsluvToRgb:e.Hsluv.hsluvToRgb,rgbToHsluv:e.Hsluv.rgbToHsluv,hpluvToRgb:e.Hsluv.hpluvToRgb,rgbToHpluv:e.Hsluv.rgbToHpluv,hsluvToHex:e.Hsluv.hsluvToHex,hexToHsluv:e.Hsluv.hexToHsluv,hpluvToHex:e.Hsluv.hpluvToHex,hexToHpluv:e.Hsluv.hexToHpluv,lchToHpluv:e.Hsluv.lchToHpluv,hpluvToLch:e.Hsluv.hpluvToLch,lchToHsluv:e.Hsluv.lchToHsluv,hsluvToLch:e.Hsluv.hsluvToLch,lchToLuv:e.Hsluv.lchToLuv,luvToLch:e.Hsluv.luvToLch,xyzToLuv:e.Hsluv.xyzToLuv,luvToXyz:e.Hsluv.luvToXyz,xyzToRgb:e.Hsluv.xyzToRgb,rgbToXyz:e.Hsluv.rgbToXyz,lchToRgb:e.Hsluv.lchToRgb,rgbToLch:e.Hsluv.rgbToLch};class r{constructor(e){this.channels=e}toString(){return this.channels.toString()}toRGBColor(){const e=n.hsluvToRgb(this.channels).map(e=>Math.floor(255*e+.5));return new s(e)}static fromString(e){const n=e.split(",").map(Number);return new r([n[0],n[1],n[2]])}get hue(){return this.channels[t]}get saturation(){return this.channels[o]}get lightness(){return this.channels[u]}}const t=0,o=1,u=2;class s{constructor(e){this.channels=e}toHSLuvColor(){const e=this.channels.map(e=>e/255),t=n.rgbToHsluv(e);return new r(t)}get red(){return this.channels[l]}get green(){return this.channels[i]}get blue(){return this.channels[a]}}const l=0,i=1,a=2;var c=async function(e){return e instanceof HTMLImageElement?function(e){return new Promise(n=>{if(e.complete){const r=v(e);n(h(r))}else{const r=()=>{const t=v(e);n(h(t)),e.removeEventListener("load",r)};e.addEventListener("load",r)}})}(e):h(e)};function v(e){const n=document.createElement("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0,e.width,e.height),n}function h(e){return e.getContext("2d").getImageData(0,0,e.width,e.height).data}class m{constructor(e){this.data=e}static async fromImageElement(e,n){const r=[],t=await c(e),o=4*(n-1);for(let e=o;e<t.length;e+=4+o){const n=new s([t[e+l],t[e+i],t[e+a]]);r.push(n)}return new m(r)}}class g{constructor(e,n){this.begin=e,this.end=n}liesIn(e){return e>=this.begin&&e<=this.end}toString(){return`[${this.begin}, ${this.end}]`}}const f=new g(1,25),p=8,H=1;function d(e){const n=function(e){const n=Object.keys(e),r=["numberOfColors","quality"],t=["rgbImage",...r],o=["imageElement",...r],u=n.filter(e=>!t.includes(e));return 0===u.length?u:n.filter(e=>!o.includes(e))}(e);return 0!==n.length?new RangeError(`parameters argument includes unknown property ${n[0]}`):e.rgbImage||e.imageElement?e.rgbImage?function(e){const{rgbImage:n}=e;if(!(n instanceof m))return new TypeError("image property should be of type RGBImage");return y(e)}(e):function(e){const{imageElement:n}=e;if(!(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement))return new TypeError("imageElement property should be of type HTMLImageElement or HTMLCanvasElement");return y(e)}(e):new RangeError("parameters argument should include either rgbImage or imageElement property")}function y(e){const{numberOfColors:n=p,quality:r=H}=e;return Number.isInteger(n)?n>=1&&n<=256?Number.isInteger(r)?f.liesIn(r)?e.rgbImage?{rgbImage:e.rgbImage,numberOfColors:n,quality:r}:{imageElement:e.imageElement,numberOfColors:n,quality:r}:new RangeError(`quality property should lie in ${f.toString()}`):new TypeError("quality property should be an integer"):new RangeError("numberOfColors property should lie in [1, 256]"):new TypeError("numberOfColors property should be an integer")}function b(e){return w(e,M)}function T(e){return w(e,I)}async function w(e,n){const r=d(e);return r instanceof Error?Promise.reject(r):n(function(e,n){let r=[e.data];for(let e=0;e<n-1;e+=1){const e=E(r),n=x(e),t=L(e,n);r.splice(r.indexOf(e),1),r=r.concat(t)}return r}(await async function(e){return e.rgbImage?e.rgbImage:m.fromImageElement(e.imageElement,e.quality)}(r),r.numberOfColors))}function E(e){return e.reduce((e,n)=>n.length>e.length?n:e)}function x(e){class n{constructor(e){this.axis=e,this.minMax=[255,0]}updateMinMax(e){this.minMax=[Math.min(e,this.minMax[0]),Math.max(e,this.minMax[1])]}get width(){return this.minMax[1]-this.minMax[0]}}const r=[new n(l),new n(i),new n(a)];return e.forEach(e=>{r[l].updateMinMax(e.red),r[i].updateMinMax(e.green),r[a].updateMinMax(e.blue)}),r.reduce((e,n)=>n.width>e.width?n:e).axis}function L(e,n){return function(e,n,r){return e.reduce((e,t)=>(e[(e=>e.channels[n]<=r?0:1)(t)].push(t),e),[[],[]])}(e,n,function(e,n){const r=e.map(e=>e.channels[n]).sort((e,n)=>e-n);return r[Math.floor(r.length/2)-1]}(e,n))}function M(e){const n=e.map(e=>{const n=C(e);return e.map(e=>({sourceColor:e,representativeColor:n}))});return[].concat(...n)}function I(e){return e.map(e=>({color:C(e),population:e.length}))}function C(e){const n=e.reduce((e,n)=>[e[l]+n.red,e[i]+n.green,e[a]+n.blue],[0,0,0]).map(n=>Math.floor(n/e.length+.5));return new s([n[l],n[i],n[a]])}class R{constructor(e){this.data=e}static fromRGBImage(e,n){const r=[],t=n-1;for(let n=t;n<e.data.length;n+=1+t){const t=[e.data[n].red,e.data[n].green,e.data[n].blue],o=new s(t).toHSLuvColor();r.push(o)}return new R(r)}static async fromImageElement(e,n){const r=[],t=await c(e),o=4*(n-1);for(let e=o;e<t.length;e+=4+o){const n=[t[e+l],t[e+i],t[e+a]],o=new s(n).toHSLuvColor();r.push(o)}return new R(r)}}const S=[15,20,20];var z=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e};function O(e){const n=function(e){const n=Object.keys(e),r=["numberOfColors","quality","regionSize"],t=["rgbImage",...r],o=["imageElement",...r],u=n.filter(e=>!t.includes(e));return 0===u.length?u:n.filter(e=>!o.includes(e))}(e);if(0!==n.length)return new RangeError(`parameters argument includes unknown property ${n[0]}`);const{regionSize:r=S}=e,[t,o,u]=r;if(3!==r.length)return new TypeError("regionSize property should be of type [number, number, number]");if(!Number.isInteger(t))return new TypeError("hue in regionSize property should be an integer");if(!(t>=1&&t<=360))return new RangeError("hue in regionSize property should lie in [1, 360]");if(!Number.isInteger(o))return new TypeError("saturation in regionSize property should be an integer");if(!(o>=1&&o<=100))return new RangeError("saturation in regionSize property should lie in [1, 100]");if(!Number.isInteger(u))return new TypeError("lightness in regionSize property should be an integer");if(!(u>=1&&u<=100))return new RangeError("lightness in regionSize property should lie in [1, 100]");const s=function(e){if(e.rgbImage){const{rgbImage:n,numberOfColors:r,quality:t}=e;return d({rgbImage:n,numberOfColors:r,quality:t})}const{imageElement:n,numberOfColors:r,quality:t}=e;return d({imageElement:n,numberOfColors:r,quality:t})}(e);return s instanceof Error?s:z({},s,{regionSize:r})}function P(e,n){let r=0;for(;n>=e[r]&&r<e.length;)r+=1;return[e[r-1],e[r]].toString()}var q=async function(e){const n=O(e);if(n instanceof Error)return Promise.reject(n);const s=await async function(e){return e.rgbImage?R.fromRGBImage(e.rgbImage,e.quality):R.fromImageElement(e.imageElement,e.quality)}(n);var l,i,a;return l=s,i=n.regionSize,a=n.numberOfColors,function(e,n){return function(e,n){const r=e.map(e=>({regionID:e[0],population:G(e[1])}));r.sort((e,n)=>n.population-e.population);const t=r.slice(0,n).map(e=>e.regionID);return e.filter(e=>t.includes(e[0]))}(e,n).map(e=>(function(e){return{color:e.map(e=>({color:r.fromString(e[0]),population:e[1]})).reduce((e,n)=>n.population>e.population?n:e).color.toRGBColor(),population:G(e)}})(e[1]))}(function(e,n){const r=new Map;return e.data.forEach(e=>{const s=function(e,n){const r=[];for(let e=0;e<360+n[t];e+=n[t])r.push(Math.min(e,360));const s=[];for(let e=0;e<100+n[o];e+=n[o])s.push(Math.min(e,100));const l=[];for(let e=0;e<100+n[u];e+=n[u])l.push(Math.min(e,100));return[P(r,e.hue),P(s,e.saturation),P(l,e.lightness)].join(",")}(e,n),l=e.toString(),i=r.get(s);if(i){const e=i.get(l);e?i.set(l,e+1):i.set(l,1)}else r.set(s,new Map([[l,1]]))}),Array.from(r.entries()).map(e=>[e[0],Array.from(e[1].entries()).map(e=>[e[0],e[1]])])}(l,i),a)};function G(e){return e.reduce((e,n)=>e+n[1],0)}var j={quantizeImage:b,reduceImage:T,popularizeImage:q};class k{constructor(){this.values=[],this.settlers=[],this.closed=!1}enqueue(e){if(this.closed)throw new Error("unable to enqueue an item onto a closed queue");if(0===this.settlers.length)this.values.push(e);else{const n=this.settlers.shift();e instanceof Error?n.reject(e.message):n.resolve({done:!1,value:e})}}[Symbol.asyncIterator](){return this}next(){if(this.values.length>0){const e=this.values.shift();return e instanceof Error?Promise.reject(e):Promise.resolve({done:!1,value:e})}return this.closed?Promise.resolve({done:!0}):new Promise((e,n)=>{this.settlers.push({resolve:e,reject:n})})}close(){if(this.settlers.length>0){this.settlers.shift().resolve({done:!0})}this.closed=!0}}const N=new g(1,24),F=1;function B(e){const n=function(e){const n=["videoElement","framesPerSecond"];return Object.keys(e).filter(e=>!n.includes(e))}(e);if(0!==n.length)return new RangeError(`parameters argument includes unknown property ${n[0]}`);const{videoElement:r,framesPerSecond:t=F}=e;return r?r instanceof HTMLVideoElement?Number.isInteger(t)?N.liesIn(t)?{videoElement:r,framesPerSecond:t}:new RangeError(`framesPerSecond property should lie in ${N.toString()}`):new TypeError("framesPerSecond property should be an integer"):new TypeError("videoElement property should be of type HTMLVideoElement"):new RangeError("parameters argument should include videoElement property")}var V=async function*(e,n){const r=B(e);if(r instanceof Error)throw r;yield*async function*(e,n){const r=e.videoElement.cloneNode(),{framesPerSecond:t}=e,o=new k;let u=0;const s=async()=>{const e=function(e){const n=document.createElement("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0,e.width,e.height),n}(r),l=await n(e);o.enqueue(l),(u+=1/t)<=r.duration?r.currentTime=u:(o.close(),r.removeEventListener("seeked",s))};if(r.addEventListener("seeked",s),4===r.readyState)r.currentTime=0;else{const e=()=>{r.currentTime=0,r.removeEventListener("loadeddata",e)};r.addEventListener("loadeddata",e)}yield*async function*e(n){const r=await n.next();r.done||(yield r.value,yield*e(n))}(o)}(r,n)};function X(e){const{videoElement:n,framesPerSecond:r,numberOfColors:t,quality:o}=e;return[{videoElement:n,framesPerSecond:r},{numberOfColors:t,quality:o}]}return z({RGBImage:m},j,{quantizeVideo:function(e){const[n,r]=X(e);return V(n,e=>b(z({imageElement:e},r)))},reduceVideo:function(e){const[n,r]=X(e);return V(n,e=>T(z({imageElement:e},r)))},popularizeVideo:function(e){const[n,r]=function(e){const{videoElement:n,framesPerSecond:r,numberOfColors:t,quality:o,regionSize:u}=e;return[{videoElement:n,framesPerSecond:r},{numberOfColors:t,quality:o,regionSize:u}]}(e);return V(n,e=>q(z({imageElement:e},r)))}})});
