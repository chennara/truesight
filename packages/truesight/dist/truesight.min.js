/*!
 * truesight.min.js v0.1.0-alpha.1
 * Copyright (c) 2018-present, Chennara Nhes.
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.truesight=t()}(this,function(){"use strict";class e{constructor(e){this.channels=e}get red(){return this.channels[t]}get green(){return this.channels[n]}get blue(){return this.channels[r]}}const t=0,n=1,r=2;function o(e,t=2e3){const n=new Promise(t=>{const n=()=>{e.removeEventListener("load",n),t()};e.addEventListener("load",n),e.complete&&0!==e.naturalWidth&&(e.removeEventListener("load",n),t())}),r=new Promise((e,n)=>{setTimeout(()=>{n(new RangeError(`failed to load the image, timeout of ${t} ms exceeded`))},t)});return Promise.race([n,r])}var u=async function(e){return e instanceof HTMLImageElement?async function(e){return await o(e),s(function(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height),t}(e))}(e):s(e)};function s(e){return e.getContext("2d").getImageData(0,0,e.width,e.height).data}class i{constructor(e){this.data=e}static async fromImageElement(o,s){const a=[],l=await u(o),c=4*(s-1);for(let o=c;o<l.length;o+=4+c){const u=new e([l[o+t],l[o+n],l[o+r]]);a.push(u)}return new i(a)}}function a(e,t){const n=Object.keys(e).filter(e=>!t.includes(e));if(0!==n.length)return new RangeError(`parameters argument includes unknown property ${n[0]}`)}const l=new class{constructor(e,t){this.begin=e,this.end=t}liesIn(e){return e>=this.begin&&e<=this.end}toString(){return`[${this.begin}, ${this.end}]`}}(1,25),c=8,h=1;var v=async function(e){if(!e.imageElement&&!e.rgbImage)throw new RangeError("parameters argument should include either imageElement or rgbImage property");return e.imageElement?async function(e){const t=a(e,["imageElement","numberOfColors","quality"]);if(t instanceof Error)throw t;const{imageElement:n}=e;if(!(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement))throw new TypeError("imageElement property should be of type HTMLImageElement or HTMLCanvasElement");n instanceof HTMLImageElement&&await o(n);return m(e)}(e):function(e){const t=a(e,["rgbImage","numberOfColors","quality"]);if(t instanceof Error)throw t;const{rgbImage:n}=e;if(!(n instanceof i))throw new TypeError("image property should be of type RGBImage");return m(e)}(e)};async function m(e){const{numberOfColors:t=c,quality:n=h}=e;if(!Number.isInteger(t))throw new TypeError("numberOfColors property should be an integer");if(!(t>=1&&t<=256))throw new RangeError("numberOfColors property should lie in [1, 256]");if(!Number.isInteger(n))throw new TypeError("quality property should be an integer");if(!l.liesIn(n))throw new RangeError(`quality property should lie in ${l.toString()}`);return e.imageElement?{imageElement:e.imageElement,numberOfColors:t,quality:n}:{rgbImage:e.rgbImage,numberOfColors:t,quality:n}}function f(e){return p(e,w)}function g(e){return p(e,b)}async function p(e,t){const n=await v(e);return t(function(e,t){let n=[e.data];for(let e=0;e<t-1;e+=1){const e=d(n),t=H(e),r=y(e,t);n.splice(n.indexOf(e),1),n=n.concat(r)}return n}(await async function(e){return e.rgbImage?e.rgbImage:i.fromImageElement(e.imageElement,e.quality)}(n),n.numberOfColors))}function d(e){return e.reduce((e,t)=>t.length>e.length?t:e)}function H(e){class o{constructor(e){this.axis=e,this.minMax=[255,0]}updateMinMax(e){this.minMax=[Math.min(e,this.minMax[0]),Math.max(e,this.minMax[1])]}get width(){return this.minMax[1]-this.minMax[0]}}const u=[new o(t),new o(n),new o(r)];return e.forEach(e=>{u[t].updateMinMax(e.red),u[n].updateMinMax(e.green),u[r].updateMinMax(e.blue)}),u.reduce((e,t)=>t.width>e.width?t:e).axis}function y(e,t){return function(e,t,n){return e.reduce((e,r)=>(e[(e=>e.channels[t]<=n?0:1)(r)].push(r),e),[[],[]])}(e,t,function(e,t){const n=e.map(e=>e.channels[t]).sort((e,t)=>e-t);return n[Math.floor(n.length/2)-1]}(e,t))}function w(e){const t=e.map(e=>{const t=T(e);return e.map(e=>({sourceColor:e,representativeColor:t}))});return[].concat(...t)}function b(e){return e.map(e=>({color:T(e),population:e.length}))}function T(o){const u=o.reduce((e,o)=>[e[t]+o.red,e[n]+o.green,e[r]+o.blue],[0,0,0]).map(e=>Math.floor(e/o.length+.5));return new e([u[t],u[n],u[r]])}class E{constructor(e){this.channels=e}toString(){return this.channels.toString()}static fromString(e){const t=e.split(",").map(Number);return new E([t[0],t[1],t[2]])}get hue(){return this.channels[x]}get saturation(){return this.channels[L]}get lightness(){return this.channels[M]}}const x=0,L=1,M=2;var I=I||{};I.Geometry=function(){},I.Geometry.intersectLineLine=function(e,t){var n=(e.intercept-t.intercept)/(t.slope-e.slope);return{x:n,y:e.slope*n+e.intercept}},I.Geometry.distanceFromOrigin=function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},I.Geometry.distanceLineFromOrigin=function(e){return Math.abs(e.intercept)/Math.sqrt(Math.pow(e.slope,2)+1)},I.Geometry.perpendicularThroughPoint=function(e,t){var n=-1/e.slope;return{slope:n,intercept:t.y-n*t.x}},I.Geometry.angleFromOrigin=function(e){return Math.atan2(e.y,e.x)},I.Geometry.normalizeAngle=function(e){var t=2*Math.PI;return(e%t+t)%t},I.Geometry.lengthOfRayUntilIntersect=function(e,t){return t.intercept/(Math.sin(e)-t.slope*Math.cos(e))},I.Hsluv=function(){},I.Hsluv.getBounds=function(e){for(var t=[],n=Math.pow(e+16,3)/1560896,r=n>I.Hsluv.epsilon?n:e/I.Hsluv.kappa,o=0;o<3;)for(var u=o++,s=I.Hsluv.m[u][0],i=I.Hsluv.m[u][1],a=I.Hsluv.m[u][2],l=0;l<2;){var c=l++,h=(284517*s-94839*a)*r,v=(838422*a+769860*i+731718*s)*e*r-769860*c*e,m=(632260*a-126452*i)*r+126452*c;t.push({slope:h/m,intercept:v/m})}return t},I.Hsluv.maxSafeChromaForL=function(e){for(var t=I.Hsluv.getBounds(e),n=1/0,r=0;r<t.length;){var o=t[r];++r;var u=I.Geometry.distanceLineFromOrigin(o);n=Math.min(n,u)}return n},I.Hsluv.maxChromaForLH=function(e,t){for(var n=t/360*Math.PI*2,r=I.Hsluv.getBounds(e),o=1/0,u=0;u<r.length;){var s=r[u];++u;var i=I.Geometry.lengthOfRayUntilIntersect(n,s);i>=0&&(o=Math.min(o,i))}return o},I.Hsluv.dotProduct=function(e,t){for(var n=0,r=0,o=e.length;r<o;){var u=r++;n+=e[u]*t[u]}return n},I.Hsluv.fromLinear=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.4166666666666667)-.055},I.Hsluv.toLinear=function(e){return e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92},I.Hsluv.xyzToRgb=function(e){return[I.Hsluv.fromLinear(I.Hsluv.dotProduct(I.Hsluv.m[0],e)),I.Hsluv.fromLinear(I.Hsluv.dotProduct(I.Hsluv.m[1],e)),I.Hsluv.fromLinear(I.Hsluv.dotProduct(I.Hsluv.m[2],e))]},I.Hsluv.rgbToXyz=function(e){var t=[I.Hsluv.toLinear(e[0]),I.Hsluv.toLinear(e[1]),I.Hsluv.toLinear(e[2])];return[I.Hsluv.dotProduct(I.Hsluv.minv[0],t),I.Hsluv.dotProduct(I.Hsluv.minv[1],t),I.Hsluv.dotProduct(I.Hsluv.minv[2],t)]},I.Hsluv.yToL=function(e){return e<=I.Hsluv.epsilon?e/I.Hsluv.refY*I.Hsluv.kappa:116*Math.pow(e/I.Hsluv.refY,.3333333333333333)-16},I.Hsluv.lToY=function(e){return e<=8?I.Hsluv.refY*e/I.Hsluv.kappa:I.Hsluv.refY*Math.pow((e+16)/116,3)},I.Hsluv.xyzToLuv=function(e){var t=e[0],n=e[1],r=t+15*n+3*e[2],o=4*t,u=9*n;0!=r?(o/=r,u/=r):(o=NaN,u=NaN);var s=I.Hsluv.yToL(n);return 0==s?[0,0,0]:[s,13*s*(o-I.Hsluv.refU),13*s*(u-I.Hsluv.refV)]},I.Hsluv.luvToXyz=function(e){var t=e[0],n=e[1],r=e[2];if(0==t)return[0,0,0];var o=n/(13*t)+I.Hsluv.refU,u=r/(13*t)+I.Hsluv.refV,s=I.Hsluv.lToY(t),i=0-9*s*o/((o-4)*u-o*u);return[i,s,(9*s-15*u*s-u*i)/(3*u)]},I.Hsluv.luvToLch=function(e){var t,n=e[0],r=e[1],o=e[2],u=Math.sqrt(r*r+o*o);u<1e-8?t=0:(t=180*Math.atan2(o,r)/Math.PI)<0&&(t=360+t);return[n,u,t]},I.Hsluv.lchToLuv=function(e){var t=e[0],n=e[1],r=e[2]/360*2*Math.PI;return[t,Math.cos(r)*n,Math.sin(r)*n]},I.Hsluv.hsluvToLch=function(e){var t=e[0],n=e[1],r=e[2];return r>99.9999999?[100,0,t]:r<1e-8?[0,0,t]:[r,I.Hsluv.maxChromaForLH(r,t)/100*n,t]},I.Hsluv.lchToHsluv=function(e){var t=e[0],n=e[1],r=e[2];return t>99.9999999?[r,0,100]:t<1e-8?[r,0,0]:[r,n/I.Hsluv.maxChromaForLH(t,r)*100,t]},I.Hsluv.hpluvToLch=function(e){var t=e[0],n=e[1],r=e[2];return r>99.9999999?[100,0,t]:r<1e-8?[0,0,t]:[r,I.Hsluv.maxSafeChromaForL(r)/100*n,t]},I.Hsluv.lchToHpluv=function(e){var t=e[0],n=e[1],r=e[2];return t>99.9999999?[r,0,100]:t<1e-8?[r,0,0]:[r,n/I.Hsluv.maxSafeChromaForL(t)*100,t]},I.Hsluv.rgbToHex=function(e){for(var t="#",n=0;n<3;){var r=e[n++],o=Math.round(255*r),u=o%16,s=(o-u)/16|0;t+=I.Hsluv.hexChars.charAt(s)+I.Hsluv.hexChars.charAt(u)}return t},I.Hsluv.hexToRgb=function(e){e=e.toLowerCase();for(var t=[],n=0;n<3;){var r=n++,o=16*I.Hsluv.hexChars.indexOf(e.charAt(2*r+1))+I.Hsluv.hexChars.indexOf(e.charAt(2*r+2));t.push(o/255)}return t},I.Hsluv.lchToRgb=function(e){return I.Hsluv.xyzToRgb(I.Hsluv.luvToXyz(I.Hsluv.lchToLuv(e)))},I.Hsluv.rgbToLch=function(e){return I.Hsluv.luvToLch(I.Hsluv.xyzToLuv(I.Hsluv.rgbToXyz(e)))},I.Hsluv.hsluvToRgb=function(e){return I.Hsluv.lchToRgb(I.Hsluv.hsluvToLch(e))},I.Hsluv.rgbToHsluv=function(e){return I.Hsluv.lchToHsluv(I.Hsluv.rgbToLch(e))},I.Hsluv.hpluvToRgb=function(e){return I.Hsluv.lchToRgb(I.Hsluv.hpluvToLch(e))},I.Hsluv.rgbToHpluv=function(e){return I.Hsluv.lchToHpluv(I.Hsluv.rgbToLch(e))},I.Hsluv.hsluvToHex=function(e){return I.Hsluv.rgbToHex(I.Hsluv.hsluvToRgb(e))},I.Hsluv.hpluvToHex=function(e){return I.Hsluv.rgbToHex(I.Hsluv.hpluvToRgb(e))},I.Hsluv.hexToHsluv=function(e){return I.Hsluv.rgbToHsluv(I.Hsluv.hexToRgb(e))},I.Hsluv.hexToHpluv=function(e){return I.Hsluv.rgbToHpluv(I.Hsluv.hexToRgb(e))},I.Hsluv.m=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],I.Hsluv.minv=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],I.Hsluv.refY=1,I.Hsluv.refU=.19783000664283,I.Hsluv.refV=.46831999493879,I.Hsluv.kappa=903.2962962,I.Hsluv.epsilon=.0088564516,I.Hsluv.hexChars="0123456789abcdef";var R={hsluvToRgb:I.Hsluv.hsluvToRgb,rgbToHsluv:I.Hsluv.rgbToHsluv,hpluvToRgb:I.Hsluv.hpluvToRgb,rgbToHpluv:I.Hsluv.rgbToHpluv,hsluvToHex:I.Hsluv.hsluvToHex,hexToHsluv:I.Hsluv.hexToHsluv,hpluvToHex:I.Hsluv.hpluvToHex,hexToHpluv:I.Hsluv.hexToHpluv,lchToHpluv:I.Hsluv.lchToHpluv,hpluvToLch:I.Hsluv.hpluvToLch,lchToHsluv:I.Hsluv.lchToHsluv,hsluvToLch:I.Hsluv.hsluvToLch,lchToLuv:I.Hsluv.lchToLuv,luvToLch:I.Hsluv.luvToLch,xyzToLuv:I.Hsluv.xyzToLuv,luvToXyz:I.Hsluv.luvToXyz,xyzToRgb:I.Hsluv.xyzToRgb,rgbToXyz:I.Hsluv.rgbToXyz,lchToRgb:I.Hsluv.lchToRgb,rgbToLch:I.Hsluv.rgbToLch};function C(e){const t=e.channels.map(e=>e/255),n=R.rgbToHsluv(t);return new E(n)}class z{constructor(e){this.data=e}static async fromImageElement(o,s){const i=[],a=await u(o),l=4*(s-1);for(let o=l;o<a.length;o+=4+l){const u=[a[o+t],a[o+n],a[o+r]],s=C(new e(u));i.push(s)}return new z(i)}static fromRGBImage(t,n){const r=[],o=n-1;for(let n=o;n<t.data.length;n+=1+o){const o=[t.data[n].red,t.data[n].green,t.data[n].blue],u=C(new e(o));r.push(u)}return new z(r)}}const O=[15,20,20];var q=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},S=async function(e){const t=function(e){if(e.imageElement)return a(e,["imageElement","numberOfColors","quality","regionSize"]);return a(e,["rgbImage","numberOfColors","quality","regionSize"])}(e);if(t instanceof Error)throw t;const{regionSize:n=O}=e;if(3!==n.length)throw new TypeError("regionSize property should be of type [number, number, number]");const[r,o,u]=n;if(!Number.isInteger(r))throw new TypeError("hue in regionSize property should be an integer");if(!(r>=1&&r<=360))throw new RangeError("hue in regionSize property should lie in [1, 360]");if(!Number.isInteger(o))throw new TypeError("saturation in regionSize property should be an integer");if(!(o>=1&&o<=100))throw new RangeError("saturation in regionSize property should lie in [1, 100]");if(!Number.isInteger(u))throw new TypeError("lightness in regionSize property should be an integer");if(!(u>=1&&u<=100))throw new RangeError("lightness in regionSize property should lie in [1, 100]");const s=await function(e){if(e.imageElement){const{imageElement:t,numberOfColors:n,quality:r}=e;return v({imageElement:t,numberOfColors:n,quality:r})}const{rgbImage:t,numberOfColors:n,quality:r}=e;return v({rgbImage:t,numberOfColors:n,quality:r})}(e);return q({},s,{regionSize:n})};function F(e,t){let n=0;for(;t>=e[n]&&n<e.length;)n+=1;return[e[n-1],e[n]].toString()}var P=async function(t){const n=await S(t),r=await async function(e){return e.rgbImage?z.fromRGBImage(e.rgbImage,e.quality):z.fromImageElement(e.imageElement,e.quality)}(n);var o,u,s;return o=r,u=n.regionSize,s=n.numberOfColors,function(t,n){return function(e,t){const n=e.map(e=>({regionID:e[0],population:B(e[1])}));n.sort((e,t)=>t.population-e.population);const r=n.slice(0,t).map(e=>e.regionID);return e.filter(e=>r.includes(e[0]))}(t,n).map(t=>(function(t){return{color:function(t){const n=R.hsluvToRgb(t.channels).map(e=>Math.floor(255*e+.5));return new e(n)}(t.map(e=>({color:E.fromString(e[0]),population:e[1]})).reduce((e,t)=>t.population>e.population?t:e).color),population:B(t)}})(t[1]))}(function(e,t){const n=new Map;return e.data.forEach(e=>{const r=function(e,t){const n=[];for(let e=0;e<360+t[x];e+=t[x])n.push(Math.min(e,360));const r=[];for(let e=0;e<100+t[L];e+=t[L])r.push(Math.min(e,100));const o=[];for(let e=0;e<100+t[M];e+=t[M])o.push(Math.min(e,100));return[F(n,e.hue),F(r,e.saturation),F(o,e.lightness)].join(",")}(e,t),o=e.toString(),u=n.get(r);if(u){const e=u.get(o);e?u.set(o,e+1):u.set(o,1)}else n.set(r,new Map([[o,1]]))}),Array.from(n.entries()).map(e=>[e[0],Array.from(e[1].entries()).map(e=>[e[0],e[1]])])}(o,u),s)};function B(e){return e.reduce((e,t)=>e+t[1],0)}class G{constructor(){this.values=[],this.settlers=[],this.closed=!1}enqueue(e){if(this.closed)throw new Error("unable to enqueue a task onto a closed queue");if(0===this.settlers.length)this.values.push(e);else{const t=this.settlers.shift();e instanceof Error?t.reject(e):t.resolve({done:!1,value:e})}}[Symbol.asyncIterator](){return this}async next(){if(this.values.length>0){const e=this.values.shift();if(e instanceof Error)throw e;return{done:!1,value:e}}return this.closed?{done:!0}:new Promise((e,t)=>{this.settlers.push({resolve:e,reject:t})})}close(){if(this.settlers.length>0){this.settlers.shift().resolve({done:!0})}this.closed=!0}}function N(e,t=2e3){const n=new Promise(t=>{const n=()=>{e.removeEventListener("loadeddata",n),t()};e.addEventListener("loadeddata",n),4===e.readyState&&(e.removeEventListener("loadeddata",n),t())}),r=new Promise((e,n)=>{setTimeout(()=>{n(new RangeError(`failed to load the video, timeout of ${t} ms exceeded`))},t)});return Promise.race([n,r])}const k=1;var V=async function*(e,t){yield*async function*(e,t){const n=new G,r=e.videoElement.cloneNode();r.preload="auto",await N(r);let o=0,u=1;r.currentTime=o;const s=async()=>{const i=function(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height),t}(r),a=async function(e){try{return await e()}catch(e){return e}}(()=>t(i));n.enqueue({index:u,timestamp:o,result:a}),o+=e.secondsBetweenFrames,u+=1,o<=r.duration?r.currentTime=o:(n.close(),r.removeEventListener("seeked",s))};await s(),r.addEventListener("seeked",s),yield*async function*e(t){const n=await t.next();n.done||(yield n.value,yield*e(t))}(n)}(await async function(e){const t=a(e,["videoElement","secondsBetweenFrames"]);if(t instanceof Error)throw t;const{videoElement:n,secondsBetweenFrames:r=k}=e;if(!n)throw new RangeError("parameters argument should include videoElement property");if(!(n instanceof HTMLVideoElement))throw new TypeError("videoElement property should be of type HTMLVideoElement");if(await N(n),0===n.width)throw new RangeError("width attribute in videoElement property is 0");if(0===n.height)throw new RangeError("height attribute in videoElement property is 0");if(!Number.isFinite(r))throw new TypeError("secondsBetweenFrames property should be a number");if(r<=0)throw new RangeError("secondsBetweenFrames property should be greater than 0");return{videoElement:n,secondsBetweenFrames:r}}(e),t)};function X(e){const{videoElement:t,secondsBetweenFrames:n,numberOfColors:r,quality:o}=e;return[{videoElement:t,secondsBetweenFrames:n},{numberOfColors:r,quality:o}]}return q({RGBImage:i},{quantizeImage:f,reduceImage:g,popularizeImage:P},{quantizeVideo:function(e){const[t,n]=X(e);return V(t,e=>f(q({imageElement:e},n)))},reduceVideo:function(e){const[t,n]=X(e);return V(t,e=>g(q({imageElement:e},n)))},popularizeVideo:function(e){const[t,n]=function(e){const{videoElement:t,secondsBetweenFrames:n,numberOfColors:r,quality:o,regionSize:u}=e;return[{videoElement:t,secondsBetweenFrames:n},{numberOfColors:r,quality:o,regionSize:u}]}(e);return V(t,e=>P(q({imageElement:e},n)))}})});
